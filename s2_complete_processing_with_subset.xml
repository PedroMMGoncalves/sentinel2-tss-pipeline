<?xml version="1.0" encoding="UTF-8"?>
    <graph id="S2_SNAP_Native_Subset">
    <version>1.0</version>

    <!-- Step 1: Read with SNAP native subset - preserves S2 structure -->
    <node id="Read">
        <operator>Read</operator>
        <sources/>
        <parameters class="com.bc.ceres.binding.dom.XppDomElement">
        <file>${sourceProduct}</file>
        <sourceBands>B1,B2,B3,B4,B5,B6,B7,B8,B8A,B9,B10,B11,B12</sourceBands>
        <copyMetadata>true</copyMetadata>
        <geometryRegion>MULTIPOLYGON (((-9.01115036010742 41.3464050292969, -7.6896185874939 41.3464050292969, -7.6896185874939 40.8278274536133, -9.01115036010742 40.8278274536133, -9.01115036010742 41.3464050292969, -9.01115036010742 41.3464050292969)))</geometryRegion>
        </parameters>
    </node>

    <!-- Step 2: S2 Resampling - works on subset with preserved S2 structure -->
    <node id="S2Resampling">
        <operator>S2Resampling</operator>
        <sources>
        <sourceProduct refid="Read"/>
        </sources>
        <parameters class="com.bc.ceres.binding.dom.XppDomElement">
        <resolution>10</resolution>
        <upsampling>Bicubic</upsampling>
        <downsampling>Mean</downsampling>
        <flagDownsampling>First</flagDownsampling>
        <resampleOnPyramidLevels>true</resampleOnPyramidLevels>
        </parameters>
    </node>

    <!-- Step 3: C2RCC - should work on properly subset and resampled S2 product -->
    <node id="c2rcc_msi">
        <operator>c2rcc.msi</operator>
        <sources>
        <sourceProduct refid="S2Resampling"/>
        </sources>
        <parameters class="com.bc.ceres.binding.dom.XppDomElement">
        <validPixelExpression>B8 &gt; 0 &amp;&amp; B8 &lt; 0.1</validPixelExpression>
        <salinity>35.0</salinity>
        <temperature>15.0</temperature>
        <ozone>330.0</ozone>
        <press>1000.0</press>
        <elevation>0.0</elevation>
        <TSMfac>1.06</TSMfac>
        <TSMexp>0.942</TSMexp>
        <CHLexp>1.04</CHLexp>
        <CHLfac>21.0</CHLfac>
        <thresholdRtosaOOS>0.05</thresholdRtosaOOS>
        <thresholdAcReflecOos>0.1</thresholdAcReflecOos>
        <thresholdCloudTDown865>0.955</thresholdCloudTDown865>
        <netSet>C2RCC-Nets</netSet>
        <useEcmwfAuxData>true</useEcmwfAuxData>
        <demName>Copernicus 90m Global DEM</demName>
        <outputAsRrs>true</outputAsRrs>
        <deriveRwFromPathAndTransmittance>false</deriveRwFromPathAndTransmittance>
        <outputRtoa>true</outputRtoa>
        <outputRtosaGc>false</outputRtosaGc>
        <outputRtosaGcAann>false</outputRtosaGcAann>
        <outputRpath>false</outputRpath>
        <outputTdown>false</outputTdown>
        <outputTup>false</outputTup>
        <outputAcReflectance>true</outputAcReflectance>
        <outputRhown>true</outputRhown>
        <outputOos>false</outputOos>
        <outputKd>true</outputKd>
        <outputUncertainties>true</outputUncertainties>
        </parameters>
    </node>

    <!-- Step 4: Write Output -->
    <node id="Write">
        <operator>Write</operator>
        <sources>
        <sourceProduct refid="c2rcc_msi"/>
        </sources>
        <parameters class="com.bc.ceres.binding.dom.XppDomElement">
        <file>${targetProduct}</file>
        <formatName>BEAM-DIMAP</formatName>
        </parameters>
    </node>

    </graph>