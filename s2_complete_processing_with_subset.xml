<?xml version="1.0" encoding="UTF-8"?>
<graph id="S2_Complete_Processing_WithSubset">
  <version>1.0</version>

  <!-- Step 1: Read Input Product -->
  <node id="Read">
    <operator>Read</operator>
    <sources/>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <file>${sourceProduct}</file>
    </parameters>
  </node>

  <!-- Step 2: S2 Resampling -->
  <node id="S2Resampling">
    <operator>S2Resampling</operator>
    <sources>
      <sourceProduct refid="Read"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <resolution>10</resolution>
      <upsampling>Bilinear</upsampling>
      <downsampling>Mean</downsampling>
      <flagDownsampling>First</flagDownsampling>
      <resampleOnPyramidLevels>true</resampleOnPyramidLevels>
    </parameters>
  </node>

  <!-- Step 3: Spatial Subset -->
  <node id="Subset">
    <operator>Subset</operator>
    <sources>
      <sourceProduct refid="S2Resampling"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <geoRegion>POLYGON ((-9.000248014601766 41.55184489155994, -8.828587378615111 41.55153486840646, -8.58399713544361 41.55163106911641, -8.584528453079997 41.36770347949192, -8.58452845421499 41.367703153754974, -8.587576094199392 40.56191352446001, -8.995755926671961 40.562748336929076, -9.000248014601766 40.56274459381024, -9.000248014601766 41.424787632326684, -9.000248014601766 41.55146767271867, -9.000248014601766 41.55184489155994))</geoRegion>
      <subSamplingX>1</subSamplingX>
      <subSamplingY>1</subSamplingY>
      <fullSwath>false</fullSwath>
      <copyMetadata>true</copyMetadata>
    </parameters>
  </node>

  <!-- Step 3.5: SAVE GEOMETRIC PRODUCTS -->
<node id="WriteGeometric">
  <operator>Write</operator>
  <sources>
    <source refid="Subset"/>
  </sources>
  <parameters class="com.bc.ceres.binding.dom.XppDomElement">
    <file>${geometricProduct}</file>
    <formatName>BEAM-DIMAP</formatName>
  </parameters>
</node>

  <!-- Step 4: C2RCC Atmospheric Correction -->
  <node id="c2rcc_msi">
    <operator>c2rcc.msi</operator>
    <sources>
      <sourceProduct refid="Subset"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <validPixelExpression>B8 &gt; 0 &amp;&amp; B8 &lt; 0.1</validPixelExpression>
        <salinity>35.0</salinity>
        <temperature>15.0</temperature>
        <ozone>330.0</ozone>
        <press>1000.0</press>
        <elevation>0.0</elevation>
        <TSMfac>1.06</TSMfac>
        <TSMexp>0.942</TSMexp>
        <CHLexp>1.04</CHLexp>
        <CHLfac>21.0</CHLfac>
        <thresholdRtosaOOS>0.05</thresholdRtosaOOS>
        <thresholdAcReflecOos>0.1</thresholdAcReflecOos>
        <thresholdCloudTDown865>0.955</thresholdCloudTDown865>
        <netSet>C2RCC-Nets</netSet>
        <useEcmwfAuxData>true</useEcmwfAuxData>
        <demName>Copernicus 30m Global DEM</demName>
        <outputAsRrs>true</outputAsRrs>
        <deriveRwFromPathAndTransmittance>false</deriveRwFromPathAndTransmittance>
        <outputRtoa>true</outputRtoa>
        <outputRtosaGc>false</outputRtosaGc>
        <outputRtosaGcAann>false</outputRtosaGcAann>
        <outputRpath>false</outputRpath>
        <outputTdown>false</outputTdown>
        <outputTup>false</outputTup>
        <outputAcReflectance>true</outputAcReflectance>
        <outputRhown>true</outputRhown>
        <outputOos>false</outputOos>
        <outputKd>true</outputKd>
        <outputUncertainties>true</outputUncertainties>
    </parameters>
  </node>

  <!-- Step 5: Write Output -->
  <node id="Write">
    <operator>Write</operator>
    <sources>
      <sourceProduct refid="c2rcc_msi"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <file>${targetProduct}</file>
      <formatName>BEAM-DIMAP</formatName>
    </parameters>
  </node>

</graph>