<?xml version="1.0" encoding="UTF-8"?>
<graph id="S2_Complete_Processing_WithSubset">
  <version>1.0</version>
  
  <!-- Step 1: Read Input Product -->
  <node id="Read">
    <operator>Read</operator>
    <sources/>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <file>${sourceProduct}</file>
    </parameters>
  </node>
  
  <!-- Step 2: S2 Resampling -->
  <node id="S2Resampling">
    <operator>S2Resampling</operator>
    <sources>
      <sourceProduct refid="Read"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <resolution>10</resolution>
      <upsampling>Bicubic</upsampling>
      <downsampling>Mean</downsampling>
      <flagDownsampling>First</flagDownsampling>
      <resampleOnPyramidLevels>true</resampleOnPyramidLevels>
    </parameters>
  </node>
  
  <!-- Step 3: Spatial Subset -->
  <node id="Subset">
    <operator>Subset</operator>
    <sources>
      <sourceProduct refid="S2Resampling"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <geoRegion>POLYGON ((-9.011150360107422 41.346405029296875, -7.6896185874938965 41.346405029296875, -7.6896185874938965 40.82782745361328, -9.011150360107422 40.82782745361328, -9.011150360107422 41.346405029296875, -9.011150360107422 41.346405029296875))</geoRegion>
      <subSamplingX>1</subSamplingX>
      <subSamplingY>1</subSamplingY>
      <fullSwath>false</fullSwath>
      <copyMetadata>true</copyMetadata>
    </parameters>
  </node>
  
  <!-- Step 4: C2RCC Atmospheric Correction -->
  <node id="c2rcc_msi">
    <operator>c2rcc.msi</operator>
    <sources>
      <sourceProduct refid="Subset"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <salinity>35.0</salinity>
        <temperature>15.0</temperature>
        <ozone>330.0</ozone>
        <press>1000.0</press>
        <elevation>0.0</elevation>
        <netSet>C2RCC-Nets</netSet>
        <demName>Copernicus 90m Global DEM</demName>
        <useEcmwfAuxData>true</useEcmwfAuxData>
        <outputAsRrs>false</outputAsRrs>
        <outputRhown>true</outputRhown>
        <outputKd>true</outputKd>
        <outputUncertainties>true</outputUncertainties>
        <outputAcReflectance>true</outputAcReflectance>
        <outputRtoa>true</outputRtoa>
        <outputRtosaGc>false</outputRtosaGc>
        <outputRtosaGcAann>false</outputRtosaGcAann>
        <outputRpath>false</outputRpath>
        <outputTdown>false</outputTdown>
        <outputTup>false</outputTup>
        <outputOos>false</outputOos>
        <deriveRwFromPathAndTransmittance>false</deriveRwFromPathAndTransmittance>
        <validPixelExpression>B8 &gt; 0 &amp;&amp; B8 &lt; 0.1</validPixelExpression>
        <thresholdRtosaOOS>0.05</thresholdRtosaOOS>
        <thresholdAcReflecOos>0.1</thresholdAcReflecOos>
        <thresholdCloudTDown865>0.955</thresholdCloudTDown865>
        <TSMfac>1.06</TSMfac>
        <TSMexp>0.942</TSMexp>
        <CHLexp>1.04</CHLexp>
        <CHLfac>21.0</CHLfac>
    </parameters>
  </node>
  
  <!-- Step 5: Write Output -->
  <node id="Write">
    <operator>Write</operator>
    <sources>
      <sourceProduct refid="c2rcc_msi"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <file>${targetProduct}</file>
      <formatName>BEAM-DIMAP</formatName>
    </parameters>
  </node>
  
</graph>